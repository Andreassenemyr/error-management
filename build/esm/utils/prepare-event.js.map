{"version":3,"file":"prepare-event.js","sources":["../../../src/utils/prepare-event.ts"],"sourcesContent":["import { Client } from \"../client\";\r\nimport { ClientOptions } from \"../options\";\r\nimport { Event, EventHint } from \"../types\";\r\nimport { v4 as uuiv4 } from \"uuid\";\r\nimport { CaptureContext, ExclusiveEventHintOrCaptureContext, ScopeContext, Scope as ScopeInterface } from \"../index\";\r\nimport { resolvedSyncPromise } from \"../transport/syncpromise\";\r\nimport { Scope } from \"../scope\";\r\n\r\nexport function prepareEvent(\r\n    options: ClientOptions,\r\n    event: Event,\r\n    hint: EventHint,\r\n    scope?: ScopeInterface,\r\n    client?: Client,\r\n): PromiseLike<Event | null> {\r\n    const prepared: Event = {\r\n        ...event,\r\n        event_id: event.event_id || hint.event_id || uuiv4(),\r\n        timestamp : event.timestamp || Date.now(),\r\n    };\r\n\r\n    applyClientOptions(prepared, options);\r\n\r\n    return resolvedSyncPromise(prepared);\r\n};\r\n\r\nfunction applyClientOptions(event: Event, options: ClientOptions): void {\r\n    const { environment, maxValueLength = 250 } = options;\r\n\r\n    if (!('environment' in event)) {\r\n        event.environment = 'environment' in options ? environment : 'production';\r\n    }\r\n\r\n    if (event.message) {\r\n        event.message = event.message.substring(0, maxValueLength);\r\n    }\r\n\r\n    const request = event.request;\r\n    if (request && request.url) {\r\n        request.url = request.url.substring(0, maxValueLength);\r\n    }\r\n}\r\n\r\nexport function parseEventHintOrCaptureContext(\r\n    hint: ExclusiveEventHintOrCaptureContext | undefined,\r\n): EventHint | undefined {\r\n    if (!hint) {\r\n      return undefined;\r\n    }\r\n  \r\n    // If you pass a Scope or `() => Scope` as CaptureContext, we just return this as captureContext\r\n    if (hintIsScopeOrFunction(hint)) {\r\n      return { captureContext: hint };\r\n    }\r\n  \r\n    if (hintIsScopeContext(hint)) {\r\n      return {\r\n        captureContext: hint,\r\n      };\r\n    }\r\n  \r\n    return hint;\r\n}\r\n\r\nfunction hintIsScopeOrFunction(\r\n    hint: CaptureContext | EventHint,\r\n): hint is ScopeInterface | ((scope: ScopeInterface) => ScopeInterface) {\r\n    return hint instanceof Scope || typeof hint === 'function';\r\n}\r\n  \r\ntype ScopeContextProperty = keyof ScopeContext;\r\nconst captureContextKeys: readonly ScopeContextProperty[] = [\r\n  'level',\r\n  'extra',\r\n  'tags',\r\n  'fingerprint',\r\n  'requestSession',\r\n] as const;\r\n\r\nfunction hintIsScopeContext(hint: Partial<ScopeContext> | EventHint): hint is Partial<ScopeContext> {\r\n  return Object.keys(hint).some(key => captureContextKeys.includes(key as ScopeContextProperty));\r\n}"],"names":["uuiv4"],"mappings":";;;;AAQO,SAAS,YAAY;AAC5B,IAAI,OAAO;AACX,IAAI,KAAK;AACT,IAAI,IAAI;AACR,IAAI,KAAK;AACT,IAAI,MAAM;AACV,EAA6B;AAC7B,IAAI,MAAM,QAAQ,GAAU;AAC5B,QAAQ,GAAG,KAAK;AAChB,QAAQ,QAAQ,EAAE,KAAK,CAAC,QAAS,IAAG,IAAI,CAAC,QAAS,IAAGA,EAAK,EAAE;AAC5D,QAAQ,SAAA,GAAY,KAAK,CAAC,SAAA,IAAa,IAAI,CAAC,GAAG,EAAE;AACjD,KAAK,CAAA;;AAEL,IAAI,kBAAkB,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAA;;AAEzC,IAAI,OAAO,mBAAmB,CAAC,QAAQ,CAAC,CAAA;AACxC;AAEA,SAAS,kBAAkB,CAAC,KAAK,EAAS,OAAO,EAAuB;AACxE,IAAI,MAAM,EAAE,WAAW,EAAE,iBAAiB,GAAA,EAAM,GAAE,OAAO,CAAA;;AAEzD,IAAI,IAAI,EAAE,iBAAiB,KAAK,CAAC,EAAE;AACnC,QAAQ,KAAK,CAAC,WAAA,GAAc,aAAA,IAAiB,OAAQ,GAAE,WAAY,GAAE,YAAY,CAAA;AACjF,KAAI;;AAEJ,IAAI,IAAI,KAAK,CAAC,OAAO,EAAE;AACvB,QAAQ,KAAK,CAAC,OAAQ,GAAE,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,EAAE,cAAc,CAAC,CAAA;AAClE,KAAI;;AAEJ,IAAI,MAAM,OAAA,GAAU,KAAK,CAAC,OAAO,CAAA;AACjC,IAAI,IAAI,OAAA,IAAW,OAAO,CAAC,GAAG,EAAE;AAChC,QAAQ,OAAO,CAAC,GAAI,GAAE,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,EAAE,cAAc,CAAC,CAAA;AAC9D,KAAI;AACJ,CAAA;;AAEO,SAAS,8BAA8B;AAC9C,IAAI,IAAI;AACR,EAAyB;AACzB,IAAI,IAAI,CAAC,IAAI,EAAE;AACf,MAAM,OAAO,SAAS,CAAA;AACtB,KAAI;;AAEJ;AACA,IAAI,IAAI,qBAAqB,CAAC,IAAI,CAAC,EAAE;AACrC,MAAM,OAAO,EAAE,cAAc,EAAE,MAAM,CAAA;AACrC,KAAI;;AAEJ,IAAI,IAAI,kBAAkB,CAAC,IAAI,CAAC,EAAE;AAClC,MAAM,OAAO;AACb,QAAQ,cAAc,EAAE,IAAI;AAC5B,OAAO,CAAA;AACP,KAAI;;AAEJ,IAAI,OAAO,IAAI,CAAA;AACf,CAAA;;AAEA,SAAS,qBAAqB;AAC9B,IAAI,IAAI;AACR,EAAwE;AACxE,IAAI,OAAO,gBAAgB,KAAA,IAAS,OAAO,IAAA,KAAS,UAAU,CAAA;AAC9D,CAAA;;AAGA,MAAM,kBAAkB,GAAoC;AAC5D,EAAE,OAAO;AACT,EAAE,OAAO;AACT,EAAE,MAAM;AACR,EAAE,aAAa;AACf,EAAE,gBAAgB;AAClB,CAAE,EAAA;;AAEF,SAAS,kBAAkB,CAAC,IAAI,EAAoE;AACpG,EAAE,OAAO,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,GAAA,IAAO,kBAAkB,CAAC,QAAQ,CAAC,GAAA,EAA4B,CAAC,CAAA;AAChG;;;;"}