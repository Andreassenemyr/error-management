{"version":3,"file":"prepare-event.js","sources":["../../../src/utils/prepare-event.ts"],"sourcesContent":["import { Client } from \"../client\";\nimport { ClientOptions } from \"../options\";\nimport { Event, EventHint } from \"../types\";\nimport { v4 as uuiv4 } from \"uuid\";\nimport { CaptureContext, ExclusiveEventHintOrCaptureContext, ScopeContext, Scope as ScopeInterface } from \"../index\";\nimport { resolvedSyncPromise } from \"../transport/syncpromise\";\nimport { Scope } from \"../scope\";\n\nexport function prepareEvent(\n    options: ClientOptions,\n    event: Event,\n    hint: EventHint,\n    scope?: ScopeInterface,\n    client?: Client,\n): PromiseLike<Event | null> {\n    const prepared: Event = {\n        ...event,\n        event_id: event.event_id || hint.event_id || uuiv4(),\n        timestamp : event.timestamp || new Date().getSeconds(),\n    };\n\n    applyClientOptions(prepared, options);\n\n    return resolvedSyncPromise(prepared);\n};\n\nfunction applyClientOptions(event: Event, options: ClientOptions): void {\n    const { environment, maxValueLength = 250 } = options;\n\n    if (!('environment' in event)) {\n        event.environment = 'environment' in options ? environment : 'production';\n    }\n\n    if (event.message) {\n        event.message = event.message.substring(0, maxValueLength);\n    }\n\n    const request = event.request;\n    if (request && request.url) {\n        request.url = request.url.substring(0, maxValueLength);\n    }\n}\n\nexport function parseEventHintOrCaptureContext(\n    hint: ExclusiveEventHintOrCaptureContext | undefined,\n): EventHint | undefined {\n    if (!hint) {\n      return undefined;\n    }\n  \n    // If you pass a Scope or `() => Scope` as CaptureContext, we just return this as captureContext\n    if (hintIsScopeOrFunction(hint)) {\n      return { captureContext: hint };\n    }\n  \n    if (hintIsScopeContext(hint)) {\n      return {\n        captureContext: hint,\n      };\n    }\n  \n    return hint;\n}\n\nfunction hintIsScopeOrFunction(\n    hint: CaptureContext | EventHint,\n): hint is ScopeInterface | ((scope: ScopeInterface) => ScopeInterface) {\n    return hint instanceof Scope || typeof hint === 'function';\n}\n  \ntype ScopeContextProperty = keyof ScopeContext;\nconst captureContextKeys: readonly ScopeContextProperty[] = [\n  'level',\n  'extra',\n  'tags',\n  'fingerprint',\n  'requestSession',\n] as const;\n\nfunction hintIsScopeContext(hint: Partial<ScopeContext> | EventHint): hint is Partial<ScopeContext> {\n  return Object.keys(hint).some(key => captureContextKeys.includes(key as ScopeContextProperty));\n}"],"names":["uuiv4"],"mappings":";;;;AAQO,SAAS,YAAY;AAC5B,IAAI,OAAO;AACX,IAAI,KAAK;AACT,IAAI,IAAI;AACR,IAAI,KAAK;AACT,IAAI,MAAM;AACV,EAA6B;AAC7B,IAAI,MAAM,QAAQ,GAAU;AAC5B,QAAQ,GAAG,KAAK;AAChB,QAAQ,QAAQ,EAAE,KAAK,CAAC,QAAS,IAAG,IAAI,CAAC,QAAS,IAAGA,EAAK,EAAE;AAC5D,QAAQ,SAAU,GAAE,KAAK,CAAC,SAAU,IAAG,IAAI,IAAI,EAAE,CAAC,UAAU,EAAE;AAC9D,KAAK,CAAA;AACL;AACA,IAAI,kBAAkB,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAA;AACzC;AACA,IAAI,OAAO,mBAAmB,CAAC,QAAQ,CAAC,CAAA;AACxC,CACA;AACA,SAAS,kBAAkB,CAAC,KAAK,EAAS,OAAO,EAAuB;AACxE,IAAI,MAAM,EAAE,WAAW,EAAE,iBAAiB,GAAA,EAAM,GAAE,OAAO,CAAA;AACzD;AACA,IAAI,IAAI,EAAE,iBAAiB,KAAK,CAAC,EAAE;AACnC,QAAQ,KAAK,CAAC,WAAA,GAAc,aAAA,IAAiB,OAAQ,GAAE,WAAY,GAAE,YAAY,CAAA;AACjF,KAAI;AACJ;AACA,IAAI,IAAI,KAAK,CAAC,OAAO,EAAE;AACvB,QAAQ,KAAK,CAAC,OAAQ,GAAE,KAAK,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,EAAE,cAAc,CAAC,CAAA;AAClE,KAAI;AACJ;AACA,IAAI,MAAM,OAAA,GAAU,KAAK,CAAC,OAAO,CAAA;AACjC,IAAI,IAAI,OAAA,IAAW,OAAO,CAAC,GAAG,EAAE;AAChC,QAAQ,OAAO,CAAC,GAAI,GAAE,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,EAAE,cAAc,CAAC,CAAA;AAC9D,KAAI;AACJ,CAAA;AACA;AACO,SAAS,8BAA8B;AAC9C,IAAI,IAAI;AACR,EAAyB;AACzB,IAAI,IAAI,CAAC,IAAI,EAAE;AACf,MAAM,OAAO,SAAS,CAAA;AACtB,KAAI;;AAEJ;AACA,IAAI,IAAI,qBAAqB,CAAC,IAAI,CAAC,EAAE;AACrC,MAAM,OAAO,EAAE,cAAc,EAAE,MAAM,CAAA;AACrC,KAAI;;AAEJ,IAAI,IAAI,kBAAkB,CAAC,IAAI,CAAC,EAAE;AAClC,MAAM,OAAO;AACb,QAAQ,cAAc,EAAE,IAAI;AAC5B,OAAO,CAAA;AACP,KAAI;;AAEJ,IAAI,OAAO,IAAI,CAAA;AACf,CAAA;AACA;AACA,SAAS,qBAAqB;AAC9B,IAAI,IAAI;AACR,EAAwE;AACxE,IAAI,OAAO,gBAAgB,KAAA,IAAS,OAAO,IAAA,KAAS,UAAU,CAAA;AAC9D,CAAA;;AAGA,MAAM,kBAAkB,GAAoC;AAC5D,EAAE,OAAO;AACT,EAAE,OAAO;AACT,EAAE,MAAM;AACR,EAAE,aAAa;AACf,EAAE,gBAAgB;AAClB,CAAE,EAAA;AACF;AACA,SAAS,kBAAkB,CAAC,IAAI,EAAoE;AACpG,EAAE,OAAO,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,GAAA,IAAO,kBAAkB,CAAC,QAAQ,CAAC,GAAA,EAA4B,CAAC,CAAA;AAChG;;;;"}