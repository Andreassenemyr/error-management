{"version":3,"file":"fetch.js","sources":["../../../src/transport/fetch.ts"],"sourcesContent":["import { BrowserTransportOptions } from \"../client\";\nimport { Transport, TransportMakeRequestResponse, TransportRequest } from \"../transport\";\nimport { createTransport } from \"./base\";\nimport { rejectedSyncPromise } from \"./syncpromise\";\nimport { FetchImpl, clearCachedFetchImplementation, getNativeFetchImplementation } from \"./utils\";\n\nexport function makeFetchTransport(\n    options: BrowserTransportOptions,\n    nativeFetch: FetchImpl | undefined = getNativeFetchImplementation(),\n): Transport {\n    let pendingBodySize = 0;\n    let pendingCount = 0;\n  \n    function makeRequest(request: TransportRequest): PromiseLike<TransportMakeRequestResponse> {\n        const requestSize = request.body.length;\n        pendingBodySize += requestSize;\n        pendingCount++;\n        \n        const requestOptions: RequestInit = {\n            body: request.body,\n            method: 'POST',\n            headers: options.headers,\n            // Outgoing requests are usually cancelled when navigating to a different page, causing a \"TypeError: Failed to\n            // fetch\" error and sending a \"network_error\" client-outcome - in Chrome, the request status shows \"(cancelled)\".\n            // The `keepalive` flag keeps outgoing requests alive, even when switching pages. We want this since we're\n            // frequently sending events right before the user is switching pages (eg. whenfinishing navigation transactions).\n            // Gotchas:\n            // - `keepalive` isn't supported by Firefox\n            // - As per spec (https://fetch.spec.whatwg.org/#http-network-or-cache-fetch):\n            //   If the sum of contentLength and inflightKeepaliveBytes is greater than 64 kibibytes, then return a network error.\n            //   We will therefore only activate the flag when we're below that limit.\n            // There is also a limit of requests that can be open at the same time, so we also limit this to 15\n            keepalive: pendingBodySize <= 60_000 && pendingCount < 15,\n            ...options.fetchOptions,\n        };\n      \n        if (!nativeFetch) {\n            clearCachedFetchImplementation();\n            return rejectedSyncPromise('No fetch implementation available');\n        }\n      \n        try {\n            return nativeFetch(options.url, requestOptions).then(response => {\n                pendingBodySize -= requestSize;\n                pendingCount--;\n                return {\n                    statusCode: response.status,\n                    headers: {\n                        'x-ribban-rate-limits': response.headers.get('X-Ribban-Rate-Limits'),\n                        'retry-after': response.headers.get('Retry-After'),\n                    },\n                };\n            });\n        } catch (e) {\n            clearCachedFetchImplementation();\n            pendingBodySize -= requestSize;\n            pendingCount--;\n            return rejectedSyncPromise(e);\n        }\n    }\n  \n    return createTransport(options, makeRequest);\n}"],"names":[],"mappings":";;;;AAMO,SAAS,kBAAkB;AAClC,IAAI,OAAO;AACX,IAAI,WAAW,GAA0B,4BAA4B,EAAE;AACvE,EAAa;AACb,IAAI,IAAI,eAAgB,GAAE,CAAC,CAAA;AAC3B,IAAI,IAAI,YAAa,GAAE,CAAC,CAAA;;AAExB,IAAI,SAAS,WAAW,CAAC,OAAO,EAA+D;AAC/F,QAAQ,MAAM,WAAY,GAAE,OAAO,CAAC,IAAI,CAAC,MAAM,CAAA;AAC/C,QAAQ,eAAA,IAAmB,WAAW,CAAA;AACtC,QAAQ,YAAY,EAAE,CAAA;;AAEtB,QAAQ,MAAM,cAAc,GAAgB;AAC5C,YAAY,IAAI,EAAE,OAAO,CAAC,IAAI;AAC9B,YAAY,MAAM,EAAE,MAAM;AAC1B,YAAY,OAAO,EAAE,OAAO,CAAC,OAAO;AACpC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,YAAY,SAAS,EAAE,eAAgB,IAAG,SAAU,YAAA,GAAe,EAAE;AACrE,YAAY,GAAG,OAAO,CAAC,YAAY;AACnC,SAAS,CAAA;;AAET,QAAQ,IAAI,CAAC,WAAW,EAAE;AAC1B,YAAY,8BAA8B,EAAE,CAAA;AAC5C,YAAY,OAAO,mBAAmB,CAAC,mCAAmC,CAAC,CAAA;AAC3E,SAAQ;;AAER,QAAQ,IAAI;AACZ,YAAY,OAAO,WAAW,CAAC,OAAO,CAAC,GAAG,EAAE,cAAc,CAAC,CAAC,IAAI,CAAC,YAAY;AAC7E,gBAAgB,eAAA,IAAmB,WAAW,CAAA;AAC9C,gBAAgB,YAAY,EAAE,CAAA;AAC9B,gBAAgB,OAAO;AACvB,oBAAoB,UAAU,EAAE,QAAQ,CAAC,MAAM;AAC/C,oBAAoB,OAAO,EAAE;AAC7B,wBAAwB,sBAAsB,EAAE,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,sBAAsB,CAAC;AAC5F,wBAAwB,aAAa,EAAE,QAAQ,CAAC,OAAO,CAAC,GAAG,CAAC,aAAa,CAAC;AAC1E,qBAAqB;AACrB,iBAAiB,CAAA;AACjB,aAAa,CAAC,CAAA;AACd,SAAU,CAAA,OAAO,CAAC,EAAE;AACpB,YAAY,8BAA8B,EAAE,CAAA;AAC5C,YAAY,eAAA,IAAmB,WAAW,CAAA;AAC1C,YAAY,YAAY,EAAE,CAAA;AAC1B,YAAY,OAAO,mBAAmB,CAAC,CAAC,CAAC,CAAA;AACzC,SAAQ;AACR,KAAI;;AAEJ,IAAI,OAAO,eAAe,CAAC,OAAO,EAAE,WAAW,CAAC,CAAA;AAChD;;;;"}