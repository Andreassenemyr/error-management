{"version":3,"file":"syncpromise.js","sources":["../../../src/transport/syncpromise.ts"],"sourcesContent":["/** SyncPromise internal states */\r\nconst enum States {\r\n  /** Pending */\r\n  PENDING = 0,\r\n  /** Resolved / OK */\r\n  RESOLVED = 1,\r\n  /** Rejected / Error */\r\n  REJECTED = 2,\r\n}\r\n\r\n// Overloads so we can call resolvedSyncPromise without arguments and generic argument\r\nexport function resolvedSyncPromise(): PromiseLike<void>;\r\nexport function resolvedSyncPromise<T>(value: T | PromiseLike<T>): PromiseLike<T>;\r\n\r\n/**\r\n * Creates a resolved sync promise.\r\n *\r\n * @param value the value to resolve the promise with\r\n * @returns the resolved sync promise\r\n */\r\nexport function resolvedSyncPromise<T>(value?: T | PromiseLike<T>): PromiseLike<T> {\r\n  return new SyncPromise(resolve => {\r\n    resolve(value);\r\n  });\r\n}\r\n\r\n/**\r\n * Creates a rejected sync promise.\r\n *\r\n * @param value the value to reject the promise with\r\n * @returns the rejected sync promise\r\n */\r\nexport function rejectedSyncPromise<T = never>(reason?: any): PromiseLike<T> {\r\n  return new SyncPromise((_, reject) => {\r\n    reject(reason);\r\n  });\r\n}\r\n\r\n/**\r\n * Thenable class that behaves like a Promise and follows it's interface\r\n * but is not async internally\r\n */\r\nclass SyncPromise<T> implements PromiseLike<T> {\r\n  private _state: States;\r\n  private _handlers: Array<[boolean, (value: T) => void, (reason: any) => any]>;\r\n  private _value: any;\r\n\r\n  public constructor(\r\n    executor: (resolve: (value?: T | PromiseLike<T> | null) => void, reject: (reason?: any) => void) => void,\r\n  ) {\r\n    this._state = States.PENDING;\r\n    this._handlers = [];\r\n\r\n    try {\r\n      executor(this._resolve, this._reject);\r\n    } catch (e) {\r\n      this._reject(e);\r\n    }\r\n  }\r\n\r\n  /** JSDoc */\r\n  public then<TResult1 = T, TResult2 = never>(\r\n    onfulfilled?: ((value: T) => TResult1 | PromiseLike<TResult1>) | null,\r\n    onrejected?: ((reason: any) => TResult2 | PromiseLike<TResult2>) | null,\r\n  ): PromiseLike<TResult1 | TResult2> {\r\n    return new SyncPromise((resolve, reject) => {\r\n      this._handlers.push([\r\n        false,\r\n        result => {\r\n          if (!onfulfilled) {\r\n            // TODO: ¯\\_(ツ)_/¯\r\n            // TODO: FIXME\r\n            resolve(result as any);\r\n          } else {\r\n            try {\r\n              resolve(onfulfilled(result));\r\n            } catch (e) {\r\n              reject(e);\r\n            }\r\n          }\r\n        },\r\n        reason => {\r\n          if (!onrejected) {\r\n            reject(reason);\r\n          } else {\r\n            try {\r\n              resolve(onrejected(reason));\r\n            } catch (e) {\r\n              reject(e);\r\n            }\r\n          }\r\n        },\r\n      ]);\r\n      this._executeHandlers();\r\n    });\r\n  }\r\n\r\n  /** JSDoc */\r\n  public catch<TResult = never>(\r\n    onrejected?: ((reason: any) => TResult | PromiseLike<TResult>) | null,\r\n  ): PromiseLike<T | TResult> {\r\n    return this.then(val => val, onrejected);\r\n  }\r\n\r\n  /** JSDoc */\r\n  public finally<TResult>(onfinally?: (() => void) | null): PromiseLike<TResult> {\r\n    return new SyncPromise<TResult>((resolve, reject) => {\r\n      let val: TResult | any;\r\n      let isRejected: boolean;\r\n\r\n      return this.then(\r\n        value => {\r\n          isRejected = false;\r\n          val = value;\r\n          if (onfinally) {\r\n            onfinally();\r\n          }\r\n        },\r\n        reason => {\r\n          isRejected = true;\r\n          val = reason;\r\n          if (onfinally) {\r\n            onfinally();\r\n          }\r\n        },\r\n      ).then(() => {\r\n        if (isRejected) {\r\n          reject(val);\r\n          return;\r\n        }\r\n\r\n        resolve(val as unknown as any);\r\n      });\r\n    });\r\n  }\r\n\r\n  /** JSDoc */\r\n  private readonly _resolve = (value?: T | PromiseLike<T> | null) => {\r\n    this._setResult(States.RESOLVED, value);\r\n  };\r\n\r\n  /** JSDoc */\r\n  private readonly _reject = (reason?: any) => {\r\n    this._setResult(States.REJECTED, reason);\r\n  };\r\n\r\n  /** JSDoc */\r\n  private readonly _setResult = (state: States, value?: T | PromiseLike<T> | any) => {\r\n    if (this._state !== States.PENDING) {\r\n      return;\r\n    }\r\n\r\n    if (isThenable(value)) {\r\n      void (value as PromiseLike<T>).then(this._resolve, this._reject);\r\n      return;\r\n    }\r\n\r\n    this._state = state;\r\n    this._value = value;\r\n\r\n    this._executeHandlers();\r\n  };\r\n\r\n  /** JSDoc */\r\n  private readonly _executeHandlers = () => {\r\n    if (this._state === States.PENDING) {\r\n      return;\r\n    }\r\n\r\n    const cachedHandlers = this._handlers.slice();\r\n    this._handlers = [];\r\n\r\n    cachedHandlers.forEach(handler => {\r\n      if (handler[0]) {\r\n        return;\r\n      }\r\n\r\n      if (this._state === States.RESOLVED) {\r\n        handler[1](this._value as unknown as any);\r\n      }\r\n\r\n      if (this._state === States.REJECTED) {\r\n        handler[2](this._value);\r\n      }\r\n\r\n      handler[0] = true;\r\n    });\r\n  };\r\n}\r\n\r\nexport function isThenable(wat: any): wat is PromiseLike<any> {\r\n    return Boolean(wat && wat.then && typeof wat.then === 'function');\r\n}\r\n\r\nexport { SyncPromise };"],"names":[],"mappings":"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"}